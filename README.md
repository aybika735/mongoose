# Mongoose – связь между Node.js и MongoDB

## Summary

Для обеспечения связи между приложением Node.js и базой данных MongoDB принято использовать [библиотеку `mongoose`](https://mongoosejs.com/). 

Включив поддержку базы данных в наш код мы значительно расширим возможности своего проекта. В принципе, мы сможем создавать приложения практически любой сложности.

Работа с `mongoose` состоит из трёх основных действий:

1) подключение к серверу MongoDB
2) создание модели под определенную запись
3) работа с этой моделью

Программист в своем коде работает с моделью – она будет похожа на обычный объект. Изменяя этот объект мы автоматически изменяем соответствующую ей запись на сервере MongoDB.

В данном челлендже ты поэтапно создаешь полноценное приложение с базой данных и поддержкой операций CRUD. 

## Releases

Подготовься к релизам: создай новый проект, установи в нём минимальный сервер, инициализируй гит.

Добавь следующие эндпоинты:

- `GET /students`
- `POST /students`
- `DELETE /students/:id`
- `PATCH /students/:id`

Под каждый из них создай пустые контроллеры.

### Release 0

Установи в зависимости пакет `mongoose`.

Импортируй этот пакет в самом начале файла `index.js`:

```javascript
const mongoose = require("mongoose");
```

После этого в том же файле пропиши код для соединения с сервером MongoDB:

```javascript
mongoose.connect("тут адрес сервера", {
  useNewUrlParser: true,
  useUnifiedTopology: true,
}).then(() => console.log('Успешно соединились с сервером MongoDB'))
.catch(() => console.log('Ошибка при соединении с сервером MongoDB'))
```

#### Откуда брать адрес сервера

Зайди на сайт mongodb.com и войди в свой аккаунт. На странице Databases (она должна открыться сразу после входа) кликни на кнопку **Connect**:
![](./assets/1.png)

В появившемся окне выбери пункт **Connect your application**. Затем найди строку, начинающуюся с `mongodb+srv://` – это и есть адрес нашего сервера.

![](./assets/2.png)

Скопируй его и перенеси в код проекта. Замени `<password>` на пароль, который ты указывал при создании БД.

В итоге файл `index.js` будет примерно таким:

```javascript
const express = require("express");
const mongoose = require("mongoose");

const app = express();

app.use(express.json());
app.use(require("./routes/students.route.js"));

mongoose.connect("mongodb+srv://into:code@cluster0.bmwz4.mongodb.net/test?retryWrites=true&w=majority", {
  useNewUrlParser: true,
  useUnifiedTopology: true,
})
  .then(() => console.log('Успешно соединились с сервером MongoDB'))
  .catch(() => console.log('Ошибка при соединении с сервером MongoDB'))

app.listen(4000, () => {
  console.log('Сервер запущен успешно')
})
```

### Release 1

Пришла пора создать модели.

Создай папку `/models`. Все наши модели всегда будут храниться именно в ней.

Далее создай файл `Student.model.js`. Запомни формат имени: Название модели с большой буквы в единственном числе + приставка `.model.js`.

Создание модели выглядит следующим образом:

```javascript
const mongoose = require("mongoose");

const studentSchema = mongoose.Schema({
  name: String,
  phone: String,
  age: Number
});

const Student = mongoose.model('Student', studentSchema);

module.exports = Student;
```

Сначала, естественно, идет импорт библиотеки. Затем создается **схема** модели. В схеме определяются какие поля будут у документа, который будет создан данной моделью и добавлен в базу MongoDB. Тут же определяются типы этих полей.

> Количество полей и их типы будут меняться в зависимости от того для каких целей используется модель. К примеру модель продукта из интернет-магазина будет выглядеть совершенно другим образом.

Предпоследняя строка создает модель по схеме `studentSchema`. Последняя строка экспортирует созданную модель.

### Release 2

Модель готова к работе.

Чаще всего модель используют в контроллерах. 

Доработай контроллер своего сервера так, чтобы:

**Запрос `POST /students` добавлял новую запись в базу данных.**

Создать новую запись можно следующим образом:

```javascript
// ...
(req, res) => {
  Student.create({
    name: 'имя студента',
    phone: 'номер телефона',
    age: 19 // возраст
  }).then(() => {
    res.json("Студент добавлен")
  })
}
// ... остальной код
```

Разберись с тем, где именно нужно писать этот код. Добавь в базу несколько студентов. Проверь добавились ли они с помощью MongoDB Compass.

**Запрос `DELETE /students/:id` удалял запись с указанным ID.**

Для удаления используй метод модели [`findByIdAndRemove()`](https://mongoosejs.com/docs/api.html#model_Model.findByIdAndRemove).

**Запрос `GET /students` возвращал все добавленные записи из коллекции.**

Для извлечения используй метод `find()`.

**Запрос `PATCH /students/:id` изменял имя клиента на то, которое указано в `req.body.name`.**

Для изменения документа используй метод `findByIdAndUpdate()`.
